unit uFrmPrincipal;

interface

uses
  Winapi.Windows, Winapi.Messages, System.SysUtils, System.Variants, System.Classes, Vcl.Graphics,
  Vcl.Controls, Vcl.Forms, Vcl.Dialogs, REST.Types, REST.Client,
  Data.Bind.Components, Data.Bind.ObjectScope, Vcl.StdCtrls, Vcl.Menus, uFrmCategoria,
  Vcl.ComCtrls, System.JSON, System.Generics.Collections, System.UITypes;

type
  TFrmPrincipal = class(TForm)
    MainMenu1: TMainMenu;
    Arquivo1: TMenuItem;
    Novaescolha1: TMenuItem;
    N1: TMenuItem;
    Sair1: TMenuItem;
    Sobre1: TMenuItem;
    ListBoxMontadoras: TListBox;
    ListBoxVeiculos: TListBox;
    RESTClientPrincipal: TRESTClient;
    RESTRequestPrincipal: TRESTRequest;
    RESTResponsePrincipal: TRESTResponse;
    ListBoxMotorizacao: TListBox;
    procedure Novaescolha1Click(Sender: TObject);
    procedure Sair1Click(Sender: TObject);
    procedure ListBoxMontadorasClick(Sender: TObject);
    procedure ListBoxVeiculosClick(Sender: TObject);
  private
    { Private declarations }
    jsonVeiculos: TJSONArray;
    jsonMotorizacao: TJSONArray;
  public
    { Public declarations }
  //baseURL: string;
  end;

var
  FrmPrincipal: TFrmPrincipal;

implementation

{$R *.dfm}

procedure TFrmPrincipal.ListBoxMontadorasClick(Sender: TObject);
  var
    baseURL: string;
    montadoraSelecionada: TJSONObject;
    I: integer;
    item: TJSONObject;

begin
  ListBoxVeiculos.Clear;
  montadoraSelecionada := FrmCategoria.jsonMontadoras.Items[ListBoxMontadoras.ItemIndex] as TJSONObject;
  baseURL := FrmCategoria.RESTClientCategoria.BaseURL;
  baseURL := StringReplace(baseURL, 'montadora', 'veiculo', [])+'&pm.assemblers='+montadoraSelecionada.GetValue('id').Value;

  RESTClientPrincipal.BaseURL := baseURL;
  try
    RESTRequestPrincipal.Execute;
    jsonVeiculos := TJSONObject.ParseJSONValue(RESTResponsePrincipal.Content) as TJSONArray;
    for I := 0 to jsonVeiculos.Count - 1 do
      begin
        item := jsonVeiculos.Items[I] as TJSONObject;
        ListBoxVeiculos.Items.Add(item.GetValue('nome').Value);
      end;

    ListBoxVeiculos.Visible := True;
  except
    MessageDlg('Não foi possível obter a lista de veiculos. Por favor, tente novamente.', mtError, [mbOK], 0);
  end;

end;

procedure TFrmPrincipal.ListBoxVeiculosClick(Sender: TObject);
  var
    baseURL: string;
    veiculoSelecionado: TJSONObject;
    I: integer;
    item: TJSONObject;

begin
  ListBoxMotorizacao.Clear;
  veiculoSelecionado := jsonVeiculos.Items[ListBoxVeiculos.ItemIndex] as TJSONObject;
  baseURL := RESTClientPrincipal.BaseURL;
  baseURL := StringReplace(baseURL, 'veiculo', 'motorizacao', [])+'&pm.vehicles='+veiculoSelecionado.GetValue('id').Value;

  RESTClientPrincipal.BaseURL := baseURL;
  try
    RESTRequestPrincipal.Execute;
    jsonMotorizacao := TJSONObject.ParseJSONValue(RESTResponsePrincipal.Content) as TJSONArray;
    for I := 0 to jsonMotorizacao.Count - 1 do
      begin
        item := jsonMotorizacao.Items[I] as TJSONObject;
        ListBoxMotorizacao.Items.Add(item.GetValue('nome').Value);
      end;

    ListBoxMotorizacao.Visible := True;
  except
    MessageDlg('Não foi possível obter a lista de motorização. Por favor, tente novamente.', mtError, [mbOK], 0);
  end;

end;

procedure TFrmPrincipal.Novaescolha1Click(Sender: TObject);
begin
  FrmCategoria.ShowModal;
end;

procedure TFrmPrincipal.Sair1Click(Sender: TObject);
begin
  Application.Terminate;
end;

end.
